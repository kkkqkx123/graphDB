# 查询上下文模块 (Query Context Module)

## 概述

查询上下文模块是 GraphDB 查询处理系统的核心组件，负责管理查询从解析、验证、规划到执行整个生命周期中的上下文信息。该模块根据不同阶段的需求，定义了多种上下文类型，每个上下文都承担着特定的职责。

## 文件结构及功能说明

### 1. `types.rs` (位于 validate 子目录) - 基础数据类型定义

定义了验证上下文中使用的所有基础数据结构：

- **SpaceInfo**: 表示图空间的基本信息，包括ID、名称和顶点ID类型
- **Column**: 表示列定义，包含列名和类型
- **ColsDef**: 列定义集合，别名为 Vec<Column>
- **Variable**: 表示查询中定义的变量（如MATCH子句中的别名），包含变量名和关联的列定义

这些类型为整个验证上下文系统提供了统一的数据格式。

### 2. `basic_context.rs` (位于 validate 子目录) - 基本验证上下文

实现了验证阶段的基础上下文管理功能，主要包括：

- **图空间管理**: 跟踪当前图空间的切换和选择状态
- **变量管理**: 管理查询中定义的变量（如MATCH子句中的别名）和它们的类型信息
- **参数管理**: 存储和检索查询参数
- **别名管理**: 维护别名到类型的映射关系
- **错误管理**: 收集和报告验证过程中发现的错误
- **元数据管理**: 追踪待创建的空间、索引等信息

### 3. `schema.rs` (位于 validate 子目录) - Schema管理

提供了数据库Schema的管理和验证功能，包含以下组件：

- **SchemaProvider Trait**: 定义了Schema访问的通用接口
- **SchemaInfo**: 存储Schema信息，包括名称、字段及其类型
- **SchemaManager**: 实现了Schema管理功能的具体实现

这个模块允许验证过程检查查询中使用的字段是否存在于相关的Schema中。

### 4. `generators.rs` (位于 validate 子目录) - 匿名生成器

提供了生成唯一标识符的功能，包括：

- **AnonVarGenerator**: 匿名变量名生成器，用于自动创建唯一的变量名
- **AnonColGenerator**: 匿名列名生成器，用于自动创建唯一的列名
- **GeneratorFactory**: 生成器的工厂类，提供默认和自定义的生成器实例

这些生成器保证了在查询处理过程中能够安全地创建不冲突的标识符，具有线程安全性。

### 5. `context.rs` (位于 validate 子目录) - 增强验证上下文

集成了所有验证功能的高级上下文类，继承了BasicValidateContext的所有功能，并增加了：

- **Schema管理集成**: 集成了Schema验证功能
- **生成器集成**: 集成了匿名变量和列生成器
- **符号表集成**: 集成了符号表管理功能
- **组合管理**: 将所有验证子系统整合在一起

### 6. `ast_context.rs` - AST查询上下文

提供了抽象语法树级别的上下文表示，定义了不同类型查询的上下文结构：

- **AstContext**: 基础AST上下文，包含查询类型和文本信息
- **GoContext**: GO查询的上下文信息，包含起始顶点、步数、边类型等
- **FetchVerticesContext**: Fetch Vertices查询的上下文
- **FetchEdgesContext**: Fetch Edges查询的上下文
- **LookupContext**: Lookup查询的上下文
- **PathContext**: Path查询的上下文
- **SubgraphContext**: Subgraph查询的上下文
- **MaintainContext**: 维护操作查询的上下文

### 7. `execution_context.rs` - 查询执行上下文

管理查询执行期间的上下文信息，存储查询变量值和查询结果的多版本历史：

- **QueryExecutionContext**: 查询级别的执行上下文，管理变量的多版本
- 支持变量值的最新版本访问和历史版本访问
- 提供线程安全的读写操作
- 支持变量历史记录的截断和管理

### 8. `expression_context.rs` - 表达式求值上下文

为表达式求值提供运行时上下文，提供：

- **QueryExpressionContext**: 表达式求值上下文
- 变量访问（从ExecutionContext）
- 列访问（从当前迭代器行）
- 属性访问（标签、边、顶点）
- 表达式内部变量管理（用于列表解析等）

### 9. `query_context.rs` - 查询上下文

管理整个查询请求的上下文，从查询引擎接收到查询请求时创建：

- **QueryContext**: 包含解析器、规划器、优化器和执行器可见的所有信息
- 整合了请求上下文、验证上下文、执行上下文
- 包含模式管理器、索引管理器、存储客户端等组件
- 提供了对象池、ID生成器、符号表等工具

### 10. `request_context.rs` - 请求上下文

管理查询请求的完整生命周期，包括：

- **SessionInfo**: 会话信息（会话ID、用户名、客户端IP和端口等）
- **RequestParams**: 请求参数（查询语句、参数、超时时间等）
- **Response**: 响应对象（成功状态、数据、错误信息等）
- **RequestStatus**: 请求状态（待处理、处理中、完成、失败、取消）
- 提供了请求生命周期管理、属性管理等功能

### 11. `mod.rs` - 模块组织和公共接口

定义了整个查询上下文模块的公共接口，重新导出关键类型，方便外部代码访问。

## 设计特点

1. **分层架构**: 不同的上下文服务于查询处理的不同阶段，职责明确
2. **线程安全**: 使用适当的同步原语确保并发访问的安全性
3. **内存管理**: 通过Arc、RwLock等实现高效的内存共享和访问
4. **生命周期管理**: 清晰地定义了各种上下文对象的生命周期

## 使用场景

- 查询解析和AST构建
- 查询语义验证
- 执行计划生成和优化
- 查询执行过程管理
- 表达式求值
- 请求和响应处理
- 会话和连接管理

## 注意事项

- 所有代码均使用简体中文编写
- 遵循Rust编码规范和最佳实践
- 包含完整的单元测试，确保功能正确性
- 模块具备良好的性能表现，适用于高频查询处理场景
- 不同于应用级别的 services::context 中的上下文，这里的上下文都是查询级别的