# nebula-3.8.0/src/common/graph 目录功能分析及迁移情况

## 一、nebula-3.8.0/src/common/graph 目录实现的功能

### 1.1 主要数据结构

该目录定义了图数据库中用于响应和错误处理的核心数据结构：

- **ErrorCode**: 定义了整个系统中使用的错误代码枚举，包括：
  - 通用错误 (0, -1, -2, etc.)
  - 图数据库相关错误 (-5到-20, -1001到-1011)
  - 元数据服务错误 (-2001到-2074)
  - 存储服务错误 (-3001到-3061)

- **AuthResponse**: 认证响应结构，包含：
  - 错误码 (errorCode)
  - 会话ID (sessionId)
  - 错误消息 (errorMsg)
  - 时区信息 (timeZoneOffsetSeconds, timeZoneName)

- **ExecutionResponse**: 执行响应结构，包含：
  - 错误码 (errorCode)
  - 延迟时间 (latencyInUs)
  - 返回数据 (data - DataSet类型)
  - 空间名称 (spaceName)
  - 错误消息 (errorMsg)
  - 执行计划描述 (planDesc)
  - 注释 (comment)

- **PlanDescription**: 执行计划描述，包含：
  - 计划节点描述 (planNodeDescs)
  - 节点索引映射 (nodeIndexMap)
  - 格式 (format)
  - 优化时间 (optimize_time_in_us)

- **PlanNodeDescription**: 单个计划节点描述，包含：
  - 节点名称 (name)
  - 节点ID (id)
  - 输出变量 (outputVar)
  - 描述信息 (description)
  - 性能分析数据 (profiles)
  - 分支信息 (branchInfo)
  - 依赖关系 (dependencies)

- **ProfilingStats**: 性能分析统计，包含：
  - 处理行数 (rows)
  - 执行耗时 (execDurationInUs)
  - 总耗时 (totalDurationInUs)
  - 其他统计信息 (otherStats)

- **PlanNodeBranchInfo**: 计划节点分支信息，包含：
  - 是否为DO分支 (isDoBranch)
  - 条件节点ID (conditionNodeId)

- **Pair**: 键值对结构，包含：
  - 键 (key)
  - 值 (value)

### 1.2 辅助功能

- 提供了各结构的JSON序列化功能
- 实现了等价比较操作
- 定义了Thrift Cpp2操作（通过GraphCpp2Ops.h）

## 二、新架构中的功能迁移情况

在新的graphDB-Rust架构中，对应功能已经迁移到src/graph/mod.rs中，具体如下：

### 2.1 错误处理
- **原始**: ErrorCode枚举定义在Response.h中
- **迁移**: Rust的错误处理使用Result<T, E>模式，错误类型定义在src/core/error.rs中

### 2.2 响应结构
- **原始**: ExecutionResponse结构
- **迁移**: GraphResponse结构，包含：
  - data: GraphData枚举类型
  - execution_time_ms: 执行时间
  - message: 消息
  - success: 成功标志

### 2.3 数据集结构
- **原始**: DataSet类型在其他模块定义，ExecutionResponse中使用
- **迁移**: GraphData枚举，支持多种数据类型包括顶点、边、路径、标量值等

### 2.4 执行统计
- **原始**: ProfilingStats结构
- **迁移**: ExecutionStats结构，包含：
  - 总顶点数 (total_vertices)
  - 总边数 (total_edges)
  - 扫描顶点数 (vertices_scanned)
  - 扫描边数 (edges_scanned)
  - 执行时间 (execution_time_ms)
  - 内存使用 (memory_used_bytes)

### 2.5 API响应
- **原始**: 通过JSON序列化功能提供
- **迁移**: ApiResponse<T>结构，专门用于API响应，包含：
  - 代码 (code)
  - 消息 (message)
  - 数据 (data)
  - 错误 (error)

### 2.6 批量操作
- **原始**: 不直接在此目录实现
- **迁移**: BatchOperation和GraphOperation，支持顶点/边的创建、更新、删除和读取操作

### 2.7 模式定义
- **原始**: 不直接在此目录实现
- **迁移**: SchemaDef、PropertyDef和IndexDef结构，提供了完整的模式定义功能

## 三、迁移总结

新的graphDB-Rust架构对nebula-3.8.0/src/common/graph中的功能进行了现代化的重构：

1. **错误处理**: 从C++枚举转向Rust的Result类型系统
2. **响应结构**: 保持了核心概念但使用了更适合Rust的类型系统
3. **序列化**: 从Thrift转向serde，提供了更灵活的序列化机制
4. **类型安全**: 利用Rust的类型系统提供编译时安全
5. **性能统计**: 保留了性能分析功能但调整了统计指标

总的来说，新架构在保持原有功能的基础上，利用了Rust语言的特性提供了更好的内存安全性和并发安全性，并且对API响应和数据结构进行了现代化的改进。