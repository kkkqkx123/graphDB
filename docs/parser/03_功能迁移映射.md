# 功能迁移映射文档

## 1. 语法规则迁移映射

### 1.1 原Nebula语法到新架构语法映射

| 原Nebula功能 | 原语法结构 | 新架构语法 | 说明 |
|-------------|------------|------------|------|
| MATCH查询 | MATCH (v:Tag) WHERE... RETURN... | MATCH (n) WHERE... RETURN... | 简化标签语法，移除命名标签 |
| CREATE节点 | INSERT VERTEX Tag VALUES... | CREATE NODE WITH {property:value} | 简化节点创建语法 |
| CREATE边 | INSERT EDGE Type VALUES... | CREATE EDGE FROM to WITH | 适应新数据模型 |
| GO查询 | GO FROM... OVER... WHERE... YIELD... | - | 考虑保留或映射到MATCH |
| DELETE节点 | DELETE VERTEX... | DELETE NODE WHERE... | 适配新语法 |
| UPDATE操作 | UPDATE VERTEX... | UPDATE NODE WHERE SET... | 适配新语法 |

### 1.2 语句结构映射

| Nebula语句类型 | Nebula文件 | 新架构模块 | 状态 |
|---------------|------------|------------|------|
| Match语句 | MatchSentence.cpp/h | src/query/parser/ast.rs | 需实现 |
| Create语句 | MutateSentences.cpp | src/query/parser/ast.rs | 需实现 |
| Delete语句 | MutateSentences.cpp | src/query/parser/ast.rs | 需实现 |
| Update语句 | MutateSentences.cpp | src/query/parser/ast.rs | 需实现 |
| Admin语句 | AdminSentences.cpp | - | 裁剪 |
| 用户管理 | UserSentences.cpp | - | 裁剪 |
| 维护语句 | MaintainSentences.cpp | - | 裁剪 |

## 2. AST节点映射

### 2.1 主要AST节点设计

```
Query (enum)
├── CreateNodeQuery
│   ├── node_alias: Option<String>
│   ├── properties: HashMap<String, Expression>
│   └── tags: Vec<String>
├── CreateEdgeQuery
│   ├── src_node: String
│   ├── dst_node: String
│   ├── edge_type: String
│   ├── properties: HashMap<String, Expression>
│   └── ranking: Option<Expression>
├── MatchQuery
│   ├── patterns: Vec<MatchPattern>
│   ├── where_clause: Option<Expression>
│   ├── return_clause: ReturnClause
│   └── limit_clause: Option<Expression>
├── DeleteQuery
│   ├── node_id: Option<Expression>
│   ├── conditions: Vec<Condition>
│   └── delete_edges: bool
└── UpdateQuery
    ├── node_id: Option<Expression>
    ├── conditions: Vec<Condition>
    ├── updates: Vec<UpdateItem>
    └── upsert: bool
```

### 2.2 表达式节点映射

| Nebula表达式类型 | 对应Token | 新架构Rust类型 | 说明 |
|----------------|-----------|----------------|------|
| ConstantExpression | INTEGER, STRING, BOOL | Value | 使用core::Value |
| ArithmeticExpression | PLUS, MINUS, STAR, DIV | BinaryOpExpr | 二元操作表达式 |
| RelationExpression | EQ, NE, LT, LE, GT, GE | BinaryOpExpr | 二元操作表达式 |
| FunctionCallExpression | LABEL '(' | FunctionCallExpr | 函数调用表达式 |
| AttributeExpression | LABEL '.' LABEL | PropertyAccessExpr | 属性访问表达式 |
| VariableExpression | VARIABLE | VariableExpr | 变量表达式 |
| LogicalExpression | AND, OR, NOT | LogicalExpr | 逻辑表达式 |

## 3. 词法分析映射

### 3.1 关键字映射

| 原始关键字 | 用法 | 新架构保留 | 说明 |
|-----------|------|------------|------|
| MATCH | 图模式匹配 | ✓ | 核心功能 |
| CREATE | 创建节点/边 | ✓ | 核心功能 |
| DELETE | 删除节点/边 | ✓ | 核心功能 |
| UPDATE | 更新节点/边 | ✓ | 核心功能 |
| INSERT | 插入数据 | ✓ | 映射到CREATE |
| WHERE | 过滤条件 | ✓ | 核心功能 |
| RETURN | 返回结果 | ✓ | 核心功能 |
| AS | 别名定义 | ✓ | 核心功能 |
| WITH | 中间结果 | ✓ | 核心功能 |
| UNWIND | 展开列表 | ✓ | 高级功能 |
| MERGE | 合并 | ✓ | 高级功能 |
| SPACE | 数据空间 | ✗ | 分布式功能，裁剪 |
| PART | 分区 | ✗ | 分布式功能，裁剪 |
| HOST | 主机管理 | ✗ | 分布式功能，裁剪 |
| USER | 用户管理 | ✗ | 安全功能，裁剪 |

### 3.2 操作符映射

| 原始操作符 | Token类型 | 新架构保留 | 说明 |
|-----------|-----------|------------|------|
| +, -, *, / | Arithmetic | ✓ | 数学运算 |
| ==, !=, <, <=, >, >= | Relational | ✓ | 关系运算 |
| AND, OR, NOT | Logical | ✓ | 逻辑运算 |
| =~ | Regex | ✓ | 正则表达式 |
| IS NULL, IS NOT NULL | NullCheck | ✓ | 空值检查 |
| IN, NOT IN | Membership | ✓ | 成员检查 |
| CONTAINS, STARTS WITH, ENDS WITH | StringOp | ✓ | 字符串操作 |

## 4. 子句映射

### 4.1 MATCH查询子句

| 子句 | Nebula实现文件 | 新架构实现 | 说明 |
|-----|---------------|------------|------|
| MatchPath | MatchPath.cpp | src/query/parser/ast.rs | 模式路径定义 |
| WhereClause | Clauses.cpp | src/query/parser/ast.rs | 过滤条件 |
| YieldClause | Clauses.cpp | src/query/parser/ast.rs | 返回投影 |
| GroupByClause | Clauses.cpp | src/query/parser/ast.rs | 分组聚合 |
| OrderByClause | Clauses.cpp | src/query/parser/ast.rs | 排序 |
| LimitClause | Clauses.cpp | src/query/parser/ast.rs | 限制数量 |

### 4.2 路径模式映射

| Nebula路径模式 | 新架构表示 | 说明 |
|---------------|------------|------|
| (start)-[edge*min..max]-(end) | MatchPath::VariableLength(n, m) | 可变长度路径 |
| (start)-[edge]-(intermediate)-[edge2]-(end) | MatchPath::Chain(Vec<Pattern>) | 路径链 |
| (start) | MatchNode::Anonymous | 匿名节点 |
| (name:Tag) | MatchNode::Labeled | 命名标签节点 |

## 5. 迁移实现步骤

### 5.1 第一阶段：基础语法支持
1. 实现词法分析器支持基本关键字和操作符
2. 实现CREATE和MATCH语句的简单形式
3. 建立AST基本结构

### 5.2 第二阶段：完整语法支持
1. 完善MATCH查询的子句解析
2. 实现DELETE、UPDATE等数据修改语句
3. 添加函数调用、表达式等高级特性

### 5.3 第三阶段：高级功能和优化
1. 支持路径模式和可变长度路径
2. 实现错误恢复和详细错误报告
3. 性能优化和安全加固

## 6. 与现有代码集成

### 6.1 QueryError集成
- 扩展现有的`QueryError::ParseError`变体
- 提供详细的错误位置和原因信息

### 6.2 Query类型集成
- 扩展现有的`Query`枚举，添加新的查询类型
- 与现有查询执行器兼容

### 6.3 与规划器集成
- AST输出格式要与`MatchPlanner`等规划器兼容
- 提供必要的中间表示用于查询优化