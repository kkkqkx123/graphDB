# 测试计划与验证策略

## 1. 测试策略概述

### 1.1 测试层次
1. **单元测试**: 测试单个模块和函数
2. **集成测试**: 测试模块间交互
3. **系统测试**: 测试端到端功能
4. **性能测试**: 验证解析性能

### 1.2 测试目标
- 验证解析器正确性: 解析结果与预期AST一致
- 验证错误处理: 正确报告和处理语法错误
- 验证性能: 满足查询响应时间要求
- 验证兼容性: 与现有系统组件兼容

## 2. 单元测试计划

### 2.1 Lexer测试
**测试文件**: `src/query/parser/lexer_test.rs`

**测试用例**:
1. **基础标记识别**
   - 关键字: CREATE, MATCH, DELETE, UPDATE, WHERE, RETURN等
   - 操作符: +, -, *, /, =, ==, !=, <, <=, >, >=, AND, OR, NOT等
   - 界符: (, ), {, }, [, ], ,, ;, . 等
   - 字面量: 整数、浮点数、字符串、布尔值

2. **标识符和变量**
   - 普通标识符
   - 包含中文的标识符
   - 以$开头的变量

3. **字符串字面量**
   - 单引号字符串
   - 双引号字符串
   - 转义字符处理
   - 多行字符串

4. **数字字面量**
   - 整数 (十进制、十六进制)
   - 浮点数
   - 负数

5. **边界情况**
   - 空输入
   - 仅包含空格和注释的输入
   - 非法字符处理

**验证点**:
- 正确识别所有标记类型
- 提供准确的位置信息
- 正确处理各种字面量格式

### 2.2 Parser测试
**测试文件**: `src/query/parser/parser_test.rs`

**测试用例**:
1. **CREATE语句**
   - CREATE NODE简单形式
   - CREATE NODE WITH属性
   - CREATE EDGE语句
   - 语法错误情况

2. **MATCH语句**
   - 简单MATCH模式
   - 复杂路径模式
   - WHERE子句
   - RETURN子句
   - LIMIT子句
   - 组合子句

3. **DELETE语句**
   - DELETE NODE
   - DELETE NODE WITH条件
   - 语法错误情况

4. **UPDATE语句**
   - UPDATE NODE SET
   - UPDATE WITH WHERE条件
   - 语法错误情况

5. **表达式解析**
   - 常量表达式
   - 变量表达式
   - 函数调用表达式
   - 算术表达式
   - 逻辑表达式
   - 属性访问表达式

6. **错误恢复测试**
   - 语法错误后的恢复
   - 多个错误的报告

**验证点**:
- 正确生成预期的AST结构
- 正确报告语法错误
- 错误恢复机制有效

### 2.3 AST测试
**测试文件**: `src/query/parser/ast_test.rs`

**测试用例**:
1. **AST节点结构**
   - 验证各种AST节点的字段正确性
   - 验证AST节点的序列化/反序列化(如果需要)

2. **AST遍历**
   - 验证AST的可遍历性
   - 实现访问者模式(如果需要)

**验证点**:
- AST结构准确表示查询逻辑
- AST节点间关系正确

## 3. 集成测试计划

### 3.1 查询管道集成测试
**测试文件**: `tests/parser_integration_test.rs`

**测试用例**:
1. **端到端查询处理**
   - 完整的查询字符串输入
   - 通过解析器→验证器→规划器→执行器的完整流程
   - 验证结果正确性

2. **与QueryExecutor集成**
   - 解析后的Query结构与QueryExecutor兼容
   - 执行结果符合预期

3. **错误处理端到端**
   - 语法错误正确传播到最终错误报告
   - 语义错误与语法错误的区分

**验证点**:
- 整个查询管道正常工作
- 解析器输出与后续组件兼容
- 错误处理正确传递

### 3.2 与现有功能兼容性测试
**测试文件**: `tests/compatibility_test.rs`

**测试用例**:
1. **现有查询继续工作**
   - 原来支持的查询继续正常工作
   - 解析器更换不影响现有功能

2. **新查询正常工作**
   - 新解析器支持的查询正常工作
   - 结果与预期一致

**验证点**:
- 保持向后兼容性
- 新功能正确实现

## 4. 性能测试计划

### 4.1 解析性能测试
**测试文件**: `benches/parser_performance.rs`

**测试用例**:
1. **简单查询解析性能**
   - 基础CREATE语句
   - 基础MATCH语句

2. **复杂查询解析性能**
   - 多层嵌套的MATCH查询
   - 包含多个子句的复杂查询

3. **大量查询吞吐测试**
   - 批量解析多个查询
   - 测试内存使用情况

**验证点**:
- 解析时间在可接受范围内
- 内存使用合理
- 处理大量查询时表现稳定

### 4.2 基准测试
- 与原Nebula解析性能对比(如可获得)
- 不同查询复杂度下的性能表现
- 内存分配和使用效率

## 5. 验证策略

### 5.1 正确性验证
1. **语法验证**: 
   - 创建各种有效查询的测试用例，确保正确解析
   - 创建各种无效查询的测试用例，确保正确报告错误

2. **语义验证**:
   - 验证生成的AST正确表示查询意图
   - 通过执行查询并检查结果验证AST正确性

### 5.2 边界条件验证
- 空查询和空格查询
- 极长查询字符串
- 嵌套层次极深的查询
- 包含各种特殊字符的查询

### 5.3 错误处理验证
- 语法错误的准确报告
- 错误恢复和多错误报告
- 错误信息的用户友好性

## 6. 测试数据准备

### 6.1 有效查询示例
```
// 简单CREATE查询
CREATE NODE WITH {name: "Alice", age: 25}

// 复杂MATCH查询
MATCH (n:Person) WHERE n.age > 18 RETURN n.name, n.age LIMIT 10

// 包含函数调用的查询
MATCH (n:Person) WHERE n.age > 18 RETURN upper(n.name), n.age
```

### 6.2 无效查询示例
```
// 缺少关键字
MATC (n) RETURN n

// 语法错误
MATCH (n WHERE n.age > 18 RETURN n

// 不匹配的括号
MATCH (n:Person WHERE n.age > 18 RETURN n)
```

## 7. 自动化测试流程

### 7.1 CI/CD集成
- 在CI流程中运行所有单元测试
- 运行集成测试验证系统功能
- 运行性能测试确保性能不退化

### 7.2 测试覆盖率
- 目标: 代码覆盖率>80%
- 重点关注解析器核心逻辑的覆盖率
- 定期报告和审查测试覆盖情况