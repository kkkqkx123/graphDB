# 新架构下Parser模块设计规范

## 1. 整体架构设计

### 1.1 Parser模块在查询管道中的位置
```
Query String → Lexer → Parser → AST → Validator → Planner → Executor
```

### 1.2 Rust模块结构
```
src/query/
├── parser/                 # 解析器模块
│   ├── mod.rs              # 解析器入口
│   ├── lexer.rs            # 词法分析器
│   ├── parser.rs           # 语法分析器
│   ├── ast.rs              # AST定义
│   ├── token.rs            # 词法标记定义
│   └── error.rs            # 解析错误定义
```

## 2. Token定义

### 2.1 词法标记类型
使用Rust枚举定义所有词法标记，包括:
- 关键字 (CREATE, MATCH, RETURN, WHERE等)
- 操作符 (EQ, NE, GT, LT, PLUS, MINUS等)
- 字面量 (INTEGER, STRING, BOOL, NULL等)
- 界符 (LPAREN, RPAREN, LBRACE, RBRACE等)
- 标识符 (IDENTIFIER)

### 2.2 Token结构
```rust
#[derive(Debug, Clone, PartialEq)]
pub struct Token {
    pub kind: TokenKind,
    pub lexeme: String,
    pub line: usize,
    pub column: usize,
}
```

## 3. AST设计

### 3.1 查询语句基类型
```rust
#[derive(Debug, Clone)]
pub enum Query {
    CreateNode(CreateNodeStatement),
    CreateEdge(CreateEdgeStatement),
    Match(MatchStatement),
    Delete(DeleteStatement),
    Update(UpdateStatement),
    // 其他语句类型...
}
```

### 3.2 主要AST节点
1. **查询语句节点**: 代表完整的查询语句
2. **子句节点**: MATCH子句、WHERE子句、YIELD子句等
3. **表达式节点**: 属性访问、函数调用、算术表达式等
4. **模式节点**: 图模式匹配的路径、节点、边定义

## 4. 解析器实现

### 4.1 词法分析器
- 将输入的查询字符串转换为Token流
- 处理字符串字面量、注释、多行输入等
- 提供准确的位置信息用于错误报告

### 4.2 语法分析器
- 采用递归下降或使用解析器生成器实现
- 将Token流转换为AST
- 实现错误恢复机制

## 5. 错误处理

### 5.1 解析错误类型
```rust
#[derive(Error, Debug)]
pub enum ParserError {
    #[error("Syntax error at line {line}, column {column}: {message}")]
    SyntaxError { line: usize, column: usize, message: String },
    #[error("Unexpected token: {token}, expected {expected}")]
    UnexpectedToken { token: String, expected: String },
    #[error("Invalid value: {value}")]
    InvalidValue { value: String },
    // 其他错误类型...
}
```

### 5.2 错误报告
- 提供准确的错误位置信息
- 提供有帮助的错误消息
- 实现错误恢复以报告多个错误

## 6. 功能裁剪和适配

### 6.1 保留功能
- 图模式匹配 (MATCH)
- 节点/边创建 (CREATE)
- 数据更新 (UPDATE)
- 数据删除 (DELETE)
- 数据查询 (GO/FETCH)

### 6.2 裁剪功能
- 分布式相关语句 (BALANCE, HOST MANAGEMENT)
- 空间管理 (SPACE相关语句)
- 多租户管理语句

## 7. 性能和安全考虑

### 7.1 性能优化
- 避免不必要的字符串拷贝
- 使用适当的缓存机制
- 优化词法分析和语法分析算法

### 7.2 安全考虑
- 查询长度限制
- 防止恶意查询导致的栈溢出
- 适当的错误信息，避免泄露系统内部信息