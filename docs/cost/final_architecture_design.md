# GraphDB 代价模型最终架构设计

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           查询优化器 (Query Optimizer)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────┐  │
│  │   计划生成器  │───▶│   代价估算器  │───▶│   计划选择器  │───▶│ 最优计划  │  │
│  └──────────────┘    └──────┬───────┘    └──────────────┘    └──────────┘  │
│                             │                                               │
│                             ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                      代价模型核心组件 (Cost Model Core)                   ││
│  ├─────────────────────────────────────────────────────────────────────────┤│
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐ ││
│  │  │  统计信息层  │  │  选择性估计  │  │  代价计算器  │  │   代价参数配置  │ ││
│  │  │ Statistics  │  │ Selectivity │  │  Cost Calc  │  │  Cost Config   │ ││
│  │  └──────┬──────┘  └─────────────┘  └─────────────┘  └────────────────┘ ││
│  │         │                                                               ││
│  │         ▼                                                               ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │                    存储层接口 (Storage Interface)                 │    ││
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────────┐ │    ││
│  │  │  │ 表统计缓存 │  │ 索引统计  │  │ 图结构统计 │  │  统计信息收集器  │ │    ││
│  │  │  │  (Cache) │  │          │  │          │  │  (ANALYZE)      │ │    ││
│  │  │  └──────────┘  └──────────┘  └──────────┘  └─────────────────┘ │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、统计信息架构

### 2.1 层级结构

```
┌─────────────────────────────────────────────────────────────────┐
│                      统计信息架构 (Statistics Architecture)        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    系统级统计 (System Statistics)          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  全局配置    │  │  存储统计    │  │   缓存命中率     │   │   │
│  │  │  (Config)   │  │  (Storage)  │  │  (Cache Stats)  │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    图级统计 (Graph Statistics)             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  标签分布    │  │  边类型分布  │  │   度分布直方图   │   │   │
│  │  │ (Tag Count) │  │(Edge Type)  │  │ (Degree Hist)   │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  连通分量    │  │  路径长度分布 │  │   聚类系数      │   │   │
│  │  │(Components) │  │(Path Len)   │  │ (Clustering)    │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    表级统计 (Table Statistics)             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │   行数      │  │   页数      │  │   平均行大小     │   │   │
│  │  │ (Row Count) │  │(Page Count) │  │  (Avg Row Size) │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  最后分析时间 │  │  数据分布    │  │   采样率        │   │   │
│  │  │(Last Analyzed)│ │(Distribution)│  │(Sample Ratio)  │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    列级统计 (Column Statistics)            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  空值比例    │  │  不同值数量  │  │   平均宽度      │   │   │
│  │  │(Null Frac)  │  │(Distinct)   │  │  (Avg Width)    │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  最常见值    │  │  直方图边界  │  │   相关性        │   │   │
│  │  │    (MCV)    │  │(Histogram)  │  │(Correlation)    │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    索引统计 (Index Statistics)             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  索引页数    │  │  索引项数量  │  │   索引高度      │   │   │
│  │  │(Index Pages)│  │(Entry Count)│  │  (Tree Height)  │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  叶节点页数  │  │  唯一值比例  │  │   聚簇因子      │   │   │
│  │  │(Leaf Pages) │  │(Uniqueness) │  │(Cluster Factor) │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心结构体设计

#### 表级统计
对应 PostgreSQL 的 `pg_class` 系统表，存储表级别的统计信息：

- `table_id`: 表的唯一标识符
- `table_name`: 表名
- `row_count`: 估计的行数 (reltuples)
- `page_count`: 数据页数 (relpages)
- `avg_row_size`: 平均行大小（字节）
- `sample_size`: 采样行数
- `sample_ratio`: 采样比例
- `last_analyzed`: 最后分析时间
- `column_stats`: 列级统计信息映射

#### 列级统计
对应 PostgreSQL 的 `pg_stats` 视图，存储列级别的统计信息：

- `column_id`: 列标识符
- `column_name`: 列名
- `null_fraction`: 空值比例 (0.0 - 1.0)
- `distinct_count`: 不同值数量
- `distinct_ratio`: 不同值比例
- `avg_width`: 平均宽度（字节）
- `correlation`: 物理顺序相关性 (-1.0 ~ 1.0)
- `mcv_values`: 最常见值列表 (Most Common Values)
- `mcv_frequencies`: 对应频率
- `histogram_bounds`: 直方图边界值
- `histogram_type`: 直方图类型（等频/等宽/压缩）
- `min_value`: 最小值
- `max_value`: 最大值

#### 索引统计
存储索引的统计信息：

- `index_id`: 索引标识符
- `index_name`: 索引名
- `table_id`: 所属表ID
- `index_type`: 索引类型
- `tree_height`: B+树高度
- `root_page`: 根页号
- `leaf_pages`: 叶节点页数
- `internal_pages`: 内部节点页数
- `entry_count`: 索引项数量
- `unique_entries`: 唯一值数量
- `duplicate_ratio`: 重复值比例
- `cluster_factor`: 聚簇度 (0.0 - 1.0)

#### 图结构统计
针对图数据库特性的统计信息：

- `total_vertices`: 总顶点数
- `tag_distribution`: 各标签顶点数分布
- `total_edges`: 总边数
- `edge_type_distribution`: 各类型边数分布
- `avg_out_degree`: 平均出度
- `avg_in_degree`: 平均入度
- `max_degree`: 最大度
- `degree_histogram`: 度分布直方图
- `connected_components`: 连通分量数
- `avg_path_length`: 平均路径长度
- `diameter`: 图直径
- `clustering_coefficient`: 聚类系数

## 三、选择性估计架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                  选择性估计器 (Selectivity Estimator)             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  条件类型分发器 (Condition Dispatcher)     │   │
│  │                                                         │   │
│  │   等值条件 ──▶ 等值选择性计算器                           │   │
│  │   范围条件 ──▶ 范围选择性计算器                           │   │
│  │   IN条件   ──▶ IN选择性计算器                             │   │
│  │   模式匹配 ──▶ 模式选择性计算器                           │   │
│  │   复合条件 ──▶ 复合条件计算器                             │   │
│  │   连接条件 ──▶ 连接选择性计算器                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  核心估计方法 (Core Methods)               │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │              等值条件选择性                        │   │   │
│  │  │                                                 │   │   │
│  │  │  IF 值在MCV中:                                  │   │   │
│  │  │     选择性 = MCV频率                             │   │   │
│  │  │  ELSE:                                          │   │   │
│  │  │     选择性 = (1 - MCV总频率) / 非MCV不同值数      │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                                                         │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │              范围条件选择性                        │   │   │
│  │  │                                                 │   │   │
│  │  │  使用直方图:                                     │   │   │
│  │  │    1. 定位值所在桶                               │   │   │
│  │  │    2. 计算桶内比例                               │   │   │
│  │  │    3. 累加前面完整桶                             │   │   │
│  │  │    选择性 = (前面桶数 + 当前桶比例) / 总桶数      │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                                                         │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │              连接选择性                           │   │   │
│  │  │                                                 │   │   │
│  │  │  等值连接:                                       │   │   │
│  │  │    选择性 = 1 / max(左不同值, 右不同值)          │   │   │
│  │  │                                                 │   │   │
│  │  │  考虑空值:                                       │   │   │
│  │  │    选择性 *= (1 - 左空值率) * (1 - 右空值率)     │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心估计方法

#### 等值条件选择性
使用 MCV（最常见值）或均匀分布假设：

1. 如果值在 MCV 列表中，直接返回对应的频率
2. 否则使用非 MCV 均匀分布假设：
   - 计算 MCV 总频率
   - 剩余频率均匀分配给非 MCV 值

#### 范围条件选择性
使用直方图进行估计：

1. 定位查询值所在的直方图桶
2. 计算在该桶内的比例（线性插值）
3. 累加前面完整桶的贡献
4. 选择性 = (前面桶数 + 当前桶比例) / 总桶数

#### 连接选择性
对于等值连接：

- 基础选择性 = 1 / max(左表不同值数, 右表不同值数)
- 空值调整 = (1 - 左空值率) × (1 - 右空值率)
- 最终选择性 = 基础选择性 × 空值调整

#### 图遍历选择性
根据度分布估计：

- 获取起始标签的顶点数
- 根据边类型或平均出度估计扩展数
- 选择性 = 扩展后的行数 / 起始行数

## 四、代价模型架构

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    代价模型 (Cost Model)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  代价参数配置 (Cost Configuration)         │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  I/O 代价参数:                                           │   │
│  │    - seq_page_cost: 1.0          (顺序页读取)            │   │
│  │    - random_page_cost: 4.0       (随机页读取)            │   │
│  │    - index_page_cost: 2.0        (索引页读取)            │   │
│  │                                                         │   │
│  │  CPU 代价参数:                                           │   │
│  │    - cpu_tuple_cost: 0.01        (行处理)                │   │
│  │    - cpu_index_tuple_cost: 0.005 (索引行处理)            │   │
│  │    - cpu_operator_cost: 0.0025   (操作符计算)            │   │
│  │    - cpu_compare_cost: 0.001     (比较操作)              │   │
│  │                                                         │   │
│  │  图特定参数:                                             │   │
│  │    - graph_traversal_cost: 0.1   (遍历步进)              │   │
│  │    - vertex_access_cost: 0.05    (顶点访问)              │   │
│  │    - edge_access_cost: 0.03      (边访问)                │   │
│  │                                                         │   │
│  │  系统参数:                                               │   │
│  │    - page_size: 8192             (页大小)                │   │
│  │    - effective_cache_size: 4GB   (有效缓存)              │   │
│  │    - parallel_workers: 4         (并行度)                │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  代价计算器 (Cost Calculators)             │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  扫描代价    │  │  过滤代价    │  │   连接代价       │   │   │
│  │  │  Scan Cost  │  │ Filter Cost │  │   Join Cost     │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│  │  │  遍历代价    │  │  排序代价    │  │   聚合代价       │   │   │
│  │  │Traversal Cost│  │  Sort Cost  │  │ Aggregate Cost  │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  计划代价估算 (Plan Cost Estimation)       │   │
│  │                                                         │   │
│  │  总代价 = 启动代价 + (选择性 × 执行代价)                   │   │
│  │                                                         │   │
│  │  启动代价: 产生第一行所需的代价                            │   │
│  │  执行代价: 产生所有行的总代价                              │   │
│  │  选择性:  条件过滤后的行数比例                             │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 代价计算公式

#### 顺序扫描代价
```
cost = (pages × seq_page_cost) + (rows × cpu_tuple_cost)
```

#### 索引扫描代价
```
index_cost = (leaf_pages × random_page_cost) + (entries × cpu_index_tuple_cost)
table_cost = (selected_pages × random_page_cost) + (selected_rows × cpu_tuple_cost)
total_cost = index_cost + table_cost
```

#### 嵌套循环连接代价
```
cost = outer_cost + (outer_rows × inner_cost)
```

#### 哈希连接代价
```
build_cost = left_cost + left_rows × (cpu_tuple_cost + cpu_operator_cost)
probe_cost = right_cost + right_rows × (cpu_tuple_cost + cpu_compare_cost)
total_cost = build_cost + probe_cost
```

#### 图遍历代价
```
cost_per_step = graph_traversal_cost + vertex_access_cost + edge_access_cost
total_cost = Σ (current_vertices × cost_per_step) for each step
```

## 五、统计信息收集架构

```
┌─────────────────────────────────────────────────────────────────┐
│              统计信息收集器 (Statistics Collector)               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  收集策略 (Collection Strategy)            │   │
│  │                                                         │   │
│  │  - 全表分析: 对所有行进行统计                             │   │
│  │  - 采样分析: 随机采样部分行 (默认)                        │   │
│  │  - 增量更新: 基于变化量更新统计                           │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  分析命令 (ANALYZE Command)                │   │
│  │                                                         │   │
│  │  ANALYZE [table_name] [column_list]                      │   │
│  │    [SAMPLE n ROWS | SAMPLE n PERCENT]                    │   │
│  │    [WITH (option = value)]                               │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  自动维护 (Auto Maintenance)               │   │
│  │                                                         │   │
│  │  - 阈值触发: 修改行数超过阈值时自动分析                    │   │
│  │  - 定时任务: 后台定期分析                                  │   │
│  │  - 手动触发: 用户主动执行 ANALYZE                         │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  存储层 (Storage Layer)                    │   │
│  │                                                         │   │
│  │  - 统计信息表: 存储在系统表中                              │   │
│  │  - 内存缓存: 热点统计信息缓存                              │   │
│  │  - 持久化: 定期写入磁盘                                    │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 六、整体数据流

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   查询解析    │────▶│   计划生成    │────▶│   计划优化    │
└──────────────┘     └──────┬───────┘     └──────┬───────┘
                            │                      │
                            ▼                      ▼
                   ┌────────────────┐     ┌────────────────┐
                   │  生成候选计划   │     │  代价估算与比较  │
                   │  (Plan Generator)│    │ (Cost Estimator)│
                   └───────┬────────┘     └───────┬────────┘
                           │                      │
                           └──────────┬───────────┘
                                      ▼
                            ┌─────────────────┐
                            │   统计信息查询    │
                            │ (Statistics Mgr) │
                            └────────┬────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │   表统计缓存   │ │   索引统计    │ │   图统计     │
            │  (Table Stats)│ │ (Index Stats)│ │(Graph Stats) │
            └──────────────┘ └──────────────┘ └──────────────┘
                    │                │                │
                    └────────────────┼────────────────┘
                                     ▼
                            ┌─────────────────┐
                            │   选择性估计器    │
                            │(Selectivity Est) │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │    代价计算器     │
                            │ (Cost Calculator)│
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │    最优计划      │
                            │ (Optimal Plan)  │
                            └─────────────────┘
```

## 七、关键设计决策

| 设计点 | 决策 | 理由 |
|-------|------|------|
| 统计信息粒度 | 表级 + 列级 + 图级 | 满足关系型和图查询的需求 |
| 直方图类型 | 等频直方图 | 适合倾斜分布，实现简单 |
| MCV 数量 | 默认 100 个 | PostgreSQL 经验值，平衡精度与内存 |
| 采样率 | 默认 10% | 统计精度与性能的平衡 |
| 代价参数 | 可配置 | 适应不同硬件环境（SSD/内存） |
| 缓存策略 | LRU + 热点预加载 | 减少统计信息查询开销 |
| 自动分析 | 阈值触发 | 保持统计信息新鲜度，避免过度分析 |

## 八、模块划分

### 8.1 文件结构

```
src/query/optimizer/core/
├── mod.rs                    # 模块导出
├── statistics.rs             # 统计信息结构体
├── selectivity.rs            # 选择性估计器
├── cost_model.rs             # 代价模型配置和计算器
└── analyze.rs                # 统计信息收集器（后续实现）
```

### 8.2 模块职责

- **statistics**: 定义所有统计信息相关的结构体，包括表级、列级、索引级和图级统计
- **selectivity**: 实现各种条件的选择性估计算法
- **cost_model**: 定义代价参数配置和各类操作的代价计算公式
- **analyze**: 实现统计信息收集命令（ANALYZE）

## 九、与现有系统的集成

### 9.1 计划节点集成

每个计划节点需要实现 `CostEstimable` trait：

```rust
pub trait CostEstimable {
    fn estimate_cost(&self, context: &CostContext) -> CostEstimate;
    fn estimate_output_rows(&self, context: &CostContext) -> u64;
}
```

### 9.2 优化器集成

优化器使用代价模型进行计划选择：

1. 生成候选计划
2. 对每个计划进行代价估算
3. 选择代价最低的计划

### 9.3 执行引擎集成

执行引擎在执行过程中收集实际统计信息，用于：

- 验证代价模型的准确性
- 反馈优化以改进统计信息
