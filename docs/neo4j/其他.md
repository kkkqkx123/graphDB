# Neo4j Cypher - 其他实用语法

## 概述

本文档涵盖 Neo4j Cypher 中不属于传统 DQL/DML/DDL/DCL 分类的其他实用语法和功能，包括子查询、过程调用、查询计划分析、图算法等。

---

## 1. CALL 子句 - 过程调用

### 1.1 调用内置过程

```cypher
// 显示所有标签
CALL db.labels()
YIELD label
RETURN *

// 显示所有关系类型
CALL db.relationshipTypes()
YIELD relationshipType
RETURN *

// 显示所有属性键
CALL db.propertyKeys()
YIELD propertyKey
RETURN *

// 获取数据库统计信息
CALL db.stats()
YIELD nodes, relationships, labels
RETURN *

// 获取索引信息
CALL db.indexes()
YIELD label, properties, type
RETURN *

// 获取约束信息
CALL db.constraints()
YIELD description
RETURN *
```

### 1.2 调用 APOC 过程（需要 APOC 插件）

```cypher
// 导出为 JSON
CALL apoc.export.json.all("export.json")

// 导出查询结果
CALL apoc.export.json.query(
  "MATCH (p:Person) RETURN p.name, p.age",
  "people.json"
)

// 导入 JSON
CALL apoc.load.json("file:///data.json")
YIELD value
RETURN value

// 批量操作
CALL apoc.periodic.iterate(
  "MATCH (n:OldData) RETURN n",
  "DETACH DELETE n",
  {batchSize: 1000, parallel: true}
)

// 生成数据
CALL apoc.periodic.repeat(
  "createData",
  "UNWIND range(1,100) AS i CREATE (:Person {id: i, name: 'Person' + i})",
  10
)
```

### 1.3 调用自定义过程

```cypher
// 调用用户定义的存储过程
CALL com.example.myProcedure(param1, param2)
YIELD result
RETURN *

// 调用用户定义的函数
MATCH (n:Person)
RETURN com.example.calculateAge(n.born) AS age
```

### 1.4 过程调用带 YIELD

```cypher
// 选择性地获取过程返回的列
CALL db.labels()
YIELD label
WHERE label STARTS WITH 'P'
RETURN label

// 多列 YIELD
CALL db.stats()
YIELD nodes, relationships
WHERE nodes > 1000
RETURN nodes, relationships
```

---

## 2. CALL 子查询

### 2.1 基本子查询

```cypher
// 对每个输入行执行子查询
MATCH (p:Person)
CALL {
  WITH p
  MATCH (p)-[:FRIENDS_WITH]->(friend)
  RETURN friend.name AS friendName
}
RETURN p.name, friendName
```

### 2.2 带变量的子查询

```cypher
// 传递变量到子查询
MATCH (john:Person {name: 'John'})
SET john.friends = []
WITH john
MATCH (john)-[:FRIEND]->(friend)
WITH john, friend
CALL (john, friend) {
  WITH john.friends AS friends
  SET john.friends = friends + friend.name
}
```

### 2.3 子查询返回多个值

```cypher
MATCH (p:Person)
CALL {
  WITH p
  MATCH (p)-[:FRIENDS_WITH]->(friend)
  RETURN friend.name AS friendName, friend.age AS friendAge
}
RETURN p.name, collect({name: friendName, age: friendAge}) AS friends
```

### 2.4 子查询中的聚合

```cypher
MATCH (p:Person)
CALL {
  WITH p
  MATCH (p)-[:FRIENDS_WITH]->(friend)
  RETURN count(friend) AS friendCount
}
RETURN p.name, friendCount
ORDER BY friendCount DESC
```

---

## 3. 事务中的子查询

### 3.1 基本事务子查询

```cypher
// 在事务中批量处理
CALL {
    MATCH (n:LargeDataset)
    SET n.processed = true
} IN TRANSACTIONS
```

### 3.2 带批次大小的事务

```cypher
// 指定每批处理的行数
CALL {
    MATCH (n:LargeDataset)
    SET n.processed = true
} IN TRANSACTIONS OF 1000 ROWS
```

### 3.3 并发事务

```cypher
// 使用并发事务提高性能
CALL {
    MATCH (n:LargeDataset)
    SET n.processed = true
} IN 4 CONCURRENT TRANSACTIONS
OF 500 ROWS
```

### 3.4 带状态报告的事务

```cypher
// 报告事务处理状态
CALL {
    MATCH (n:LargeDataset)
    SET n.processed = true
} IN TRANSACTIONS OF 1000 ROWS
REPORT STATUS AS status

// 使用状态信息
CALL {
    MATCH (n:LargeDataset)
    SET n.processed = true
} IN TRANSACTIONS OF 1000 ROWS
REPORT STATUS AS status
YIELD batches, total, failed
RETURN batches, total, failed
```

### 3.5 错误处理

```cypher
// 遇到错误时继续
CALL {
    MATCH (n:Data)
    SET n.value = n.value * 2
} IN TRANSACTIONS OF 1000 ROWS
ON ERROR CONTINUE

// 遇到错误时中断
CALL {
    MATCH (n:Data)
    SET n.value = n.value * 2
} IN TRANSACTIONS OF 1000 ROWS
ON ERROR BREAK

// 遇到错误时失败
CALL {
    MATCH (n:Data)
    SET n.value = n.value * 2
} IN TRANSACTIONS OF 1000 ROWS
ON ERROR FAIL

// 带重试的错误处理
CALL {
    MATCH (n:Data)
    SET n.value = n.value * 2
} IN TRANSACTIONS OF 1000 ROWS
ON ERROR RETRY FOR 30 SECONDS THEN CONTINUE

// 带重试次数的错误处理
CALL {
    MATCH (n:Data)
    SET n.value = n.value * 2
} IN TRANSACTIONS OF 1000 ROWS
ON ERROR RETRY 3 TIMES THEN FAIL
```

---

## 4. 查询计划分析

### 4.1 EXPLAIN - 解释查询计划

```cypher
// 查看查询执行计划（不执行查询）
EXPLAIN MATCH (p:Person {name: "Alice"}) RETURN p

// 查看复杂查询的计划
EXPLAIN
MATCH (p:Person)-[:FRIENDS_WITH]->(friend)
WHERE p.age > 18
RETURN p.name, friend.name
ORDER BY friend.name
LIMIT 10

// 查看带索引提示的计划
EXPLAIN
MATCH (p:Person {name: "Alice"})
USING INDEX p:Person(name)
RETURN p
```

### 4.2 PROFILE - 性能分析

```cypher
// 分析查询性能（执行查询并返回统计信息）
PROFILE MATCH (p:Person {name: "Alice"}) RETURN p

// 分析复杂查询
PROFILE
MATCH (p:Person)-[:FRIENDS_WITH]->(friend)
WHERE p.age > 18
WITH p, collect(friend) AS friends
WHERE size(friends) > 5
RETURN p.name, size(friends) AS friendCount

// 比较不同查询计划的性能
PROFILE
MATCH (p:Person)
WHERE p.name STARTS WITH 'A'
RETURN p

PROFILE
MATCH (p:Person)
USING INDEX p:Person(name)
WHERE p.name STARTS WITH 'A'
RETURN p
```

### 4.3 查询计划解读

```cypher
// 常见操作符说明：
// AllNodesScan - 扫描所有节点
// NodeByLabelScan - 按标签扫描节点
// NodeUniqueIndexSeek - 唯一索引查找
// NodeIndexSeek - 索引查找
// NodeIndexRangeScan - 索引范围扫描
// Expand - 扩展关系
// Filter - 过滤
// Sort - 排序
// Limit - 限制结果数
// Projection - 投影（选择返回列）
// Aggregate - 聚合

// 示例：查看索引使用情况
EXPLAIN
MATCH (p:Person {name: "Alice"})
RETURN p
// 预期看到：NodeIndexSeek 或 NodeUniqueIndexSeek

// 示例：查看全表扫描
EXPLAIN
MATCH (p:Person)
WHERE p.age > 18
RETURN p
// 如果没有索引，会看到：AllNodesScan + Filter
```

---

## 5. USE 子句 - 图引用

### 5.1 静态图引用

```cypher
// 切换到指定图
USE myComposite.myGraph
MATCH (n)
RETURN count(n)
```

### 5.2 动态图引用

```cypher
// 使用表达式指定图
USE graph.byName($graphName)
MATCH (n)
RETURN count(n)
```

### 5.3 跨图查询

```cypher
// 在一个查询中使用多个图
USE graph1
MATCH (p:Person)
WITH collect(p.name) AS names1
USE graph2
MATCH (p:Person)
WITH names1, collect(p.name) AS names2
RETURN names1, names2
```

---

## 6. 图算法

### 6.1 路径查找算法

```cypher
// Dijkstra 最短路径（需要 GDS 库）
CALL gds.shortestPath.dijkstra.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH',
  startNode: $startNode,
  endNode: $endNode,
  relationshipWeightProperty: 'weight'
})
YIELD totalCost, path
RETURN totalCost, path

// A* 最短路径
CALL gds.shortestPath.astar.stream({
  nodeProjection: 'Location',
  relationshipProjection: 'CONNECTS',
  startNode: $startNode,
  endNode: $endNode,
  relationshipWeightProperty: 'distance',
  latitudeProperty: 'lat',
  longitudeProperty: 'lon'
})
YIELD totalCost, path
RETURN totalCost, path
```

### 6.2 中心性算法

```cypher
// PageRank
CALL gds.pageRank.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH',
  maxIterations: 20,
  dampingFactor: 0.85
})
YIELD nodeId, score
RETURN gds.util.asNode(nodeId).name AS name, score
ORDER BY score DESC

// 度中心性
CALL gds.degree.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH'
})
YIELD nodeId, score
RETURN gds.util.asNode(nodeId).name AS name, score
ORDER BY score DESC

// 介数中心性
CALL gds.betweenness.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH'
})
YIELD nodeId, score
RETURN gds.util.asNode(nodeId).name AS name, score
ORDER BY score DESC
```

### 6.3 社区检测算法

```cypher
// Louvain 社区检测
CALL gds.louvain.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH'
})
YIELD nodeId, communityId
RETURN gds.util.asNode(nodeId).name AS name, communityId
ORDER BY communityId

// 标签传播
CALL gds.labelPropagation.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH'
})
YIELD nodeId, communityId
RETURN gds.util.asNode(nodeId).name AS name, communityId
```

### 6.4 相似度算法

```cypher
// 节点相似度
CALL gds.nodeSimilarity.stream({
  nodeProjection: 'Person',
  relationshipProjection: 'FRIENDS_WITH',
  similarityCutoff: 0.5
})
YIELD node1, node2, similarity
RETURN gds.util.asNode(node1).name AS name1,
       gds.util.asNode(node2).name AS name2,
       similarity
ORDER BY similarity DESC
```

---

## 7. 参数化查询

### 7.1 查询参数

```cypher
// 使用参数（在驱动程序中设置）
MATCH (p:Person {name: $name})
RETURN p

// 多个参数
MATCH (p:Person)
WHERE p.age >= $minAge AND p.age <= $maxAge
RETURN p

// 参数用于关系类型
MATCH (p:Person)-[r:$relType]->(friend)
RETURN p, r, friend

// 参数用于标签
MATCH (p:$label {name: $name})
RETURN p
```

### 7.2 参数用于动态查询

```cypher
// 参数用于属性键
MATCH (p:Person)
WHERE p[$propertyKey] = $propertyValue
RETURN p

// 参数用于排序
MATCH (p:Person)
RETURN p
ORDER BY p[$sortBy]
LIMIT $limit

// 参数用于跳过和限制
MATCH (p:Person)
RETURN p
SKIP $skip
LIMIT $limit
```

---

## 8. 高级模式匹配

### 8.1 命名路径

```cypher
// 命名单个路径
MATCH p = (a:Person)-[:FRIENDS_WITH]->(b:Person)
RETURN p, a.name, b.name

// 命名多个路径
MATCH
  p1 = (a:Person)-[:FRIENDS_WITH]->(b:Person),
  p2 = (b)-[:WORKS_WITH]->(c:Person)
RETURN p1, p2
```

### 8.2 可变长度关系

```cypher
// 固定长度
MATCH (a:Person)-[:FRIENDS_WITH*3]->(b:Person)
RETURN a, b

// 范围长度
MATCH (a:Person)-[:FRIENDS_WITH*1..5]->(b:Person)
RETURN a, b

// 无上限
MATCH (a:Person)-[:FRIENDS_WITH*]->(b:Person)
RETURN a, b

// 带关系类型的可变长度
MATCH (a:Person)-[:FRIENDS_WITH | WORKS_WITH*1..3]->(b:Person)
RETURN a, b

// 带条件的可变长度
MATCH (a:Person)-[r:FRIENDS_WITH*1..5 WHERE r.since > 2020]->(b:Person)
RETURN a, b
```

### 8.3 量化路径模式

```cypher
// 匹配恰好 3 个朋友
MATCH (p:Person)-[:FRIENDS_WITH]->(f:Person)
WITH p, count(f) AS friendCount
WHERE friendCount = 3
RETURN p

// 使用量化语法
MATCH (p:Person)-[:FRIENDS_WITH]->(f:Person)
WHERE ALL(f IN collect(f) WHERE f.age > 18)
RETURN p
```

---

## 9. 条件表达式

### 9.1 CASE 表达式

```cypher
// 简单 CASE
MATCH (p:Person)
RETURN p.name,
       CASE p.age
         WHEN < 18 THEN "Minor"
         WHEN >= 18 AND < 65 THEN "Adult"
         ELSE "Senior"
       END AS ageGroup

// 搜索 CASE
MATCH (p:Person)
RETURN p.name,
       CASE
         WHEN p.age < 18 THEN "Minor"
         WHEN p.age >= 18 AND p.age < 65 THEN "Adult"
         ELSE "Senior"
       END AS ageGroup

// CASE 在 WHERE 中
MATCH (p:Person)
WHERE CASE p.status
        WHEN "active" THEN true
        WHEN "pending" THEN p.created > date() - duration({days: 30})
        ELSE false
      END
RETURN p
```

### 9.2 COALESCE - 空值处理

```cypher
// 返回第一个非空值
MATCH (p:Person)
RETURN p.nickname, coalesce(p.nickname, p.name, "Unknown") AS displayName

// 提供默认值
MATCH (p:Person)
RETURN p.name, coalesce(p.age, 0) AS age
```

### 9.3 NULLIF - 条件空值

```cypher
// 如果相等则返回 NULL
MATCH (p:Person)
RETURN p.name, nullif(p.age, 0) AS age
```

---

## 10. 列表高级操作

### 10.1 列表推导

```cypher
// 基本列表推导
MATCH (p:Person)
RETURN [n IN p.names | toUpper(n)] AS upperNames

// 带条件的列表推导
MATCH (p:Person)
RETURN [n IN p.names WHERE n STARTS WITH 'A' | toUpper(n)] AS aNames

// 嵌套列表推导
MATCH (p:Person)
RETURN [[n IN names | toUpper(n)] FOR names IN p.allNames]
```

### 10.2 列表谓词

```cypher
// ALL - 所有元素满足条件
MATCH (p:Person)
WHERE ALL(x IN p.scores WHERE x > 60)
RETURN p

// ANY - 任意元素满足条件
MATCH (p:Person)
WHERE ANY(x IN p.scores WHERE x > 90)
RETURN p

// NONE - 没有元素满足条件
MATCH (p:Person)
WHERE NONE(x IN p.scores WHERE x < 50)
RETURN p

// SINGLE - 恰好一个元素满足条件
MATCH (p:Person)
WHERE SINGLE(x IN p.scores WHERE x > 90)
RETURN p
```

### 10.3 列表函数

```cypher
// 列表长度
MATCH (p:Person)
RETURN size(p.names) AS nameCount

// 列表切片
MATCH (p:Person)
RETURN p.names[0] AS firstName,
       p.names[-1] AS lastName,
       p.names[1..3] AS middleNames

// 列表连接
MATCH (p:Person)
RETURN p.names + p.nicknames AS allNames

// 列表包含
MATCH (p:Person)
WHERE "Alice" IN p.names
RETURN p

// 列表转字符串
MATCH (p:Person)
RETURN reduce(s = "", n IN p.names | s + n + ", ") AS namesString
```

---

## 11. 字符串高级操作

### 11.1 字符串格式化

```cypher
// 字符串连接
MATCH (p:Person)
RETURN p.firstName + " " + p.lastName AS fullName

// 使用 apoc 格式化（需要 APOC）
MATCH (p:Person)
RETURN apoc.text.format("%s %s", [p.firstName, p.lastName]) AS fullName
```

### 11.2 字符串搜索

```cypher
// 查找子串位置
MATCH (p:Person)
RETURN p.name, indexOf(p.name, " ") AS spacePosition

// 替换子串
MATCH (p:Person)
RETURN replace(p.name, "John", "Johnny") AS newName
```

---

## 12. 时间高级操作

### 12.1 时间计算

```cypher
// 日期加减
RETURN date() + duration({days: 7}) AS nextWeek,
       date() - duration({months: 1}) AS lastMonth

// 日期差
MATCH (p:Person)
RETURN p.name, duration.between(date(p.born), date()).years AS age

// 时间范围
MATCH (e:Event)
WHERE e.date >= date("2026-01-01") AND e.date <= date("2026-12-31")
RETURN e
```

### 12.2 时间格式化

```cypher
// 格式化日期
MATCH (e:Event)
RETURN e.date, toString(e.date) AS dateString

// 解析日期
RETURN date("2026-02-17") AS specificDate,
       date({year: 2026, month: 2, day: 17}) AS constructedDate
```

---

## 13. 空间数据操作

### 13.1 点类型

```cypher
// 创建点
CREATE (l:Location {name: "Home", coordinates: point({x: 10, y: 20})})

// 创建地理坐标点
CREATE (l:Location {name: "Office", coordinates: point({latitude: 40.7128, longitude: -74.0060})})

// 计算距离
MATCH (a:Location {name: "Home"}), (b:Location {name: "Office"})
RETURN point.distance(a.coordinates, b.coordinates) AS distanceInMeters

// 查找附近的点
WITH point({latitude: 40.7128, longitude: -74.0060}) AS home
MATCH (l:Location)
WHERE point.distance(l.coordinates, home) < 1000
RETURN l.name, point.distance(l.coordinates, home) AS distance
```

---

## 14. 调试和日志

### 14.1 调试查询

```cypher
// 使用 RETURN 输出中间结果
MATCH (p:Person)
WITH p, count() AS cnt
RETURN p.name, cnt
LIMIT 10

// 使用 apoc.log.info（需要 APOC）
MATCH (p:Person)
CALL apoc.log.info("Processing person: " + p.name, {id: p.id})
RETURN p
```

### 14.2 性能调试

```cypher
// 使用 PROFILE 查看执行统计
PROFILE
MATCH (p:Person {name: "Alice"})
RETURN p

// 查看缓存使用情况
CALL db.cache()
YIELD label, property, size
RETURN *
```

---

## 参考文档

- [Neo4j Cypher Manual 25](https://neo4j.com/docs/cypher-manual/25/)
- [Neo4j Cypher Manual 25 - CALL](https://neo4j.com/docs/cypher-manual/25/clauses/call/)
- [Neo4j Cypher Manual 25 - Subqueries](https://neo4j.com/docs/cypher-manual/25/subqueries/)
- [Neo4j Graph Data Science Library](https://neo4j.com/docs/graph-data-science/current/)
- [APOC Procedures](https://neo4j.com/docs/apoc/current/)
