# GraphDB 单实例服务管理脚本设计文档

## 1. 需求分析

### 1.1 目标用户

- 个人开发者
- 本地开发测试人员
- 小型项目部署者

### 1.2 核心需求

| 需求类别 | 具体需求 | 优先级 |
|----------|----------|--------|
| 服务启动 | 后台启动，不占用终端 | P0 |
| 服务停止 | 优雅关闭运行中的实例 | P0 |
| 状态检查 | 查看服务运行状态 | P0 |
| 日志查看 | 方便地查看运行日志 | P1 |
| 交互 CLI | 简单的查询交互界面 | P2 |
| 信息统计 | 数据存储、日志大小等 | P2 |

### 1.3 使用场景

```powershell
# 场景 1: 快速启动服务（后台运行）
.\scripts\graphdb.ps1 start

# 场景 2: 查看服务状态
.\scripts\graphdb.ps1 status

# 场景 3: 查看日志
.\scripts\graphdb.ps1 logs

# 场景 4: 停止服务
.\scripts\graphdb.ps1 stop

# 场景 5: 交互式查询
.\scripts\graphdb.ps1 cli
```

---

## 2. 脚本架构设计

### 2.1 整体架构

```
graphdb.ps1
├── 参数解析
│   ├── Command: start/stop/restart/status/logs/cli/info
│   ├── ConfigPath: 配置文件路径
│   ├── DataDir: 数据目录
│   └── LogDir: 日志目录
├── 核心函数
│   ├── Get-GraphDBProcess      # 进程查找
│   ├── Test-PortInUse          # 端口检查
│   ├── Get-ServiceStatus       # 状态获取
│   ├── Start-GraphDBService    # 启动服务
│   ├── Stop-GraphDBService     # 停止服务
│   ├── Show-ServiceStatus      # 显示状态
│   ├── Show-Logs               # 显示日志
│   ├── Show-ServiceInfo        # 显示信息
│   └── Start-GraphDBCli        # 交互 CLI
└── 主入口
    └── switch 命令分发
```

### 2.2 进程管理机制

#### 2.2.1 PID 文件机制

```powershell
# PID 文件路径: data/graphdb.pid
# 内容: 进程 ID

# 启动时
$process.Id | Out-File $Script:PidFile -Force

# 停止时
Remove-Item $Script:PidFile -Force

# 查找进程时
if (Test-Path $Script:PidFile) {
    $pid = Get-Content $Script:PidFile -Raw
    $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
}
```

#### 2.2.2 进程查找策略

```powershell
function Get-GraphDBProcess {
    # 1. 首先尝试通过 PID 文件查找
    if (Test-Path $Script:PidFile) {
        $pid = Get-Content $Script:PidFile -Raw
        $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
        if ($process -and $process.ProcessName -match "graphdb") {
            return $process
        }
        # PID 文件存在但进程不存在，清理 PID 文件
        Remove-Item $Script:PidFile -Force
    }
    
    # 2. 通过进程名查找
    $process = Get-Process | Where-Object { 
        $_.ProcessName -match "graphdb" -or 
        $_.Path -match "graphdb\.exe$" 
    } | Select-Object -First 1
    
    return $process
}
```

---

## 3. 功能模块设计

### 3.1 服务启动 (start)

#### 3.1.1 启动流程

```
1. 检查是否已运行
   └── 如果运行中，提示并退出

2. 检查端口占用
   └── 如果端口被占用，报错并退出

3. 检查配置文件
   └── 如果不存在，使用默认配置

4. 创建必要目录
   ├── 数据目录 (data/)
   └── 日志目录 (logs/)

5. 查找可执行文件
   ├── .\graphdb.exe
   ├── .\target\release\graphdb.exe
   └── .\target\debug\graphdb.exe

6. 启动服务
   ├── 前台模式: 直接运行，阻塞终端
   └── 后台模式: Start-Job，返回 PID

7. 保存 PID 文件

8. 输出状态信息
```

#### 3.1.2 后台启动实现

```powershell
# 使用 Start-Job 实现后台运行
$job = Start-Job -ScriptBlock {
    param($exe, $config)
    & $exe serve --config $config
} -ArgumentList $exePath, $ConfigPath

# 等待服务初始化
Start-Sleep -Seconds 2

# 获取实际进程并保存 PID
$process = Get-GraphDBProcess
$process.Id | Out-File $Script:PidFile -Force
```

#### 3.1.3 启动参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `-Command start` | 启动服务 | `graphdb.ps1 start` |
| `-ConfigPath` | 指定配置文件 | `graphdb.ps1 start -ConfigPath myconfig.toml` |
| `-Foreground` | 前台运行 | `graphdb.ps1 start -Foreground` |

### 3.2 服务停止 (stop)

#### 3.2.1 停止流程

```
1. 查找运行中的进程
   └── 通过 PID 文件或进程名

2. 如果未找到进程
   ├── 提示服务未运行
   └── 清理 PID 文件
   └── 退出

3. 优雅终止
   ├── 发送 CloseMainWindow()
   ├── 等待 2 秒
   └── 检查是否已退出

4. 强制终止（如果需要）
   └── Stop-Process -Force

5. 清理 PID 文件

6. 输出结果
```

#### 3.2.2 优雅关闭实现

```powershell
function Stop-GraphDBService {
    $process = Get-GraphDBProcess
    
    if (-not $process) {
        Write-ColorOutput "GraphDB 服务未运行" -Color "Warning"
        Remove-Item $Script:PidFile -Force -ErrorAction SilentlyContinue
        return
    }
    
    try {
        # 优雅终止
        $process.CloseMainWindow() | Out-Null
        Start-Sleep -Seconds 2
        
        # 检查是否仍在运行
        if (-not $process.HasExited) {
            # 强制终止
            Stop-Process -Id $process.Id -Force
        }
        
        Write-ColorOutput "GraphDB 服务已停止" -Color "Success"
    } catch {
        Write-ColorOutput "停止服务时出错: $_" -Color "Error"
    } finally {
        Remove-Item $Script:PidFile -Force -ErrorAction SilentlyContinue
    }
}
```

### 3.3 状态检查 (status)

#### 3.3.1 状态信息

| 信息项 | 说明 | 获取方式 |
|--------|------|----------|
| 运行状态 | 是否运行中 | Get-GraphDBProcess |
| PID | 进程 ID | 进程对象 |
| 启动时间 | 进程启动时间 | $process.StartTime |
| 内存使用 | 工作集大小 | $process.WorkingSet64 |
| CPU时间 | 总处理器时间 | $process.TotalProcessorTime |
| 监听地址 | host:port | 解析配置文件 |
| 端口占用 | 端口是否被占用 | Test-PortInUse |
| 数据目录 | 数据存储位置 | 配置参数 |
| 日志目录 | 日志存储位置 | 配置参数 |

#### 3.3.2 配置文件解析

```powershell
# 简单 TOML 解析
$content = Get-Content $ConfigPath -Raw

# 提取端口
if ($content -match 'port\s*=\s*(\d+)') {
    $config.Port = [int]$matches[1]
}

# 提取主机
if ($content -match 'host\s*=\s*"([^"]+)"') {
    $config.Host = $matches[1]
}
```

### 3.4 日志查看 (logs)

#### 3.4.1 日志文件定位

```powershell
# 日志文件优先级
1. logs/graphdb.rCURRENT.log  (当前活动日志)
2. logs/graphdb.log           (主日志)
```

#### 3.4.2 日志着色显示

```powershell
Get-Content $targetLog -Tail $Lines | ForEach-Object {
    if ($_ -match "ERROR") {
        Write-ColorOutput $_ -Color "Error"
    } elseif ($_ -match "WARN") {
        Write-ColorOutput $_ -Color "Warning"
    } elseif ($_ -match "INFO") {
        Write-ColorOutput $_ -Color "Info"
    } else {
        Write-ColorOutput $_ -Color "Normal"
    }
}
```

#### 3.4.3 日志参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `-Lines 50` | 显示最后 50 行 | `graphdb.ps1 logs -Lines 50` |
| `-Lines 0` | 实时跟踪日志 | `graphdb.ps1 logs -Lines 0` |

### 3.5 交互 CLI (cli)

#### 3.5.1 功能说明

提供一个简单的交互式命令行界面，方便执行查询。

#### 3.5.2 工作流程

```
1. 检查服务是否运行
   └── 未运行则提示并退出

2. 显示提示信息

3. 循环读取输入
   ├── 读取用户输入
   ├── 如果是 "exit"，退出
   ├── 如果是空输入，继续
   └── 执行查询并显示结果

4. 查询执行
   └── 调用 graphdb.exe query --query "..."
```

#### 3.5.3 交互示例

```
GraphDB 交互式 CLI
输入 SQL 查询或命令 (exit 退出)
==================
graphdb> MATCH (n) RETURN n LIMIT 5
[查询结果...]
graphdb> SHOW SPACES
[查询结果...]
graphdb> exit
```

### 3.6 信息统计 (info)

#### 3.6.1 统计内容

| 类别 | 统计项 | 说明 |
|------|--------|------|
| 版本信息 | 可执行文件版本 | `graphdb.exe --version` |
| 数据存储 | 数据目录大小 | 递归计算 |
| | 文件数量 | 统计文件数 |
| 日志信息 | 日志目录大小 | 计算所有日志 |
| | 日志文件数 | 统计日志文件 |
| 使用帮助 | 常用命令提示 | 显示帮助信息 |

#### 3.6.2 目录大小计算

```powershell
$dataSize = (Get-ChildItem $DataDir -Recurse -ErrorAction SilentlyContinue | 
            Measure-Object -Property Length -Sum).Sum
Write-ColorOutput "数据大小: $([math]::Round($dataSize / 1MB, 2)) MB"
```

---

## 4. 辅助功能设计

### 4.1 颜色输出

```powershell
$Colors = @{
    Info = "Cyan"
    Success = "Green"
    Warning = "Yellow"
    Error = "Red"
    Normal = "White"
}

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White",
        [switch]$NoNewline
    )
    Write-Host -Object $Message -ForegroundColor $Colors[$Color] -NoNewline:$NoNewline
}
```

### 4.2 端口检测

```powershell
function Test-PortInUse {
    param([int]$Port)
    try {
        $listener = [System.Net.Sockets.TcpListener]::new(
            [System.Net.IPAddress]::Any, $Port
        )
        $listener.Start()
        $listener.Stop()
        return $false  # 端口可用
    } catch {
        return $true   # 端口被占用
    }
}
```

### 4.3 可执行文件查找

```powershell
$exePaths = @(
    ".\graphdb.exe"
    ".\target\release\graphdb.exe"
    ".\target\debug\graphdb.exe"
)

foreach ($path in $exePaths) {
    if (Test-Path $path) {
        $exePath = Resolve-Path $path
        break
    }
}
```

---

## 5. 使用示例

### 5.1 快速开始

```powershell
# 1. 启动服务（后台运行）
.\scripts\graphdb.ps1 start

# 2. 查看状态
.\scripts\graphdb.ps1 status

# 3. 查看日志
.\scripts\graphdb.ps1 logs

# 4. 停止服务
.\scripts\graphdb.ps1 stop
```

### 5.2 高级用法

```powershell
# 使用自定义配置启动
.\scripts\graphdb.ps1 start -ConfigPath config.prod.toml

# 前台运行（查看启动日志）
.\scripts\graphdb.ps1 start -Foreground

# 查看最后 100 行日志
.\scripts\graphdb.ps1 logs -Lines 100

# 实时跟踪日志
.\scripts\graphdb.ps1 logs -Lines 0

# 重启服务
.\scripts\graphdb.ps1 restart

# 查看详细信息
.\scripts\graphdb.ps1 info

# 进入交互式 CLI
.\scripts\graphdb.ps1 cli
```

### 5.3 常用别名配置

```powershell
# 添加到 PowerShell profile
Set-Alias -Name gdb -Value .\scripts\graphdb.ps1

# 使用别名
gdb start
gdb status
gdb stop
```

---

## 6. 错误处理

### 6.1 常见错误及处理

| 错误场景 | 处理方式 |
|----------|----------|
| 服务已在运行 | 提示 PID，不重复启动 |
| 端口被占用 | 检查端口，提示冲突 |
| 配置文件不存在 | 使用默认配置，提示警告 |
| 可执行文件找不到 | 搜索常见路径，报错提示 |
| PID 文件存在但进程不存在 | 清理 PID 文件，继续操作 |
| 停止时进程不存在 | 清理 PID 文件，提示已停止 |

### 6.2 错误输出示例

```
# 服务已在运行
GraphDB 服务已在运行 (PID: 12345)

# 端口被占用
端口 9758 已被占用

# 找不到可执行文件
找不到 GraphDB 可执行文件
请确保 graphdb.exe 在当前目录或 target/release/ 目录中

# 服务未运行
GraphDB 服务未运行，请先启动服务
使用: .\scripts\graphdb.ps1 start
```

---

## 7. 扩展建议

### 7.1 可能的扩展功能

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 自动重启 | 服务崩溃后自动重启 | P2 |
| 定时备份 | 定时备份数据目录 | P2 |
| 性能监控 | 定期收集性能指标 | P3 |
| 日志轮转 | 自动清理旧日志 | P2 |
| 多实例管理 | 管理多个服务实例 | P3 |

### 7.2 与系统集成

```powershell
# 注册为 Windows 服务（使用 nssm）
nssm install GraphDB (Resolve-Path .\graphdb.exe)
nssm set GraphDB AppDirectory (Resolve-Path .)
nssm set GraphDB AppParameters "serve --config config.toml"

# 启动服务
Start-Service GraphDB
```

---

## 8. 总结

本脚本设计针对单实例、个人使用场景，提供了完整的服务管理功能：

1. **简单易用**: 一条命令完成启动、停止、查看状态
2. **后台运行**: 不占用终端，适合长期运行
3. **进程管理**: PID 文件机制，可靠追踪服务状态
4. **日志友好**: 着色显示，支持实时跟踪
5. **交互支持**: 提供简单的 CLI 界面
6. **信息完整**: 状态、统计、帮助信息一应俱全

脚本位于 `scripts/graphdb.ps1`，可直接使用。
