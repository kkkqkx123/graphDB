# GraphDB 服务管理脚本使用说明

## 概述

`graphdb.ps1` 是 GraphDB 单实例服务管理脚本，用于方便地启动、停止、监控数据库服务。适用于个人开发、本地测试等场景。

---

## 快速开始

### 1. 启动服务

```powershell
# 后台启动（推荐）
.\scripts\graphdb.ps1 start

# 输出示例：
# 正在启动 GraphDB 服务...
# 使用可执行文件: D:\项目\database\graphDB\target\release\graphdb.exe
# GraphDB 服务已启动
#   PID: 12345
#   地址: http://127.0.0.1:9758
#   数据目录: D:\项目\database\graphDB\data
#   日志目录: D:\项目\database\graphDB\logs
#   查看日志: .\scripts\graphdb.ps1 logs
#   停止服务: .\scripts\graphdb.ps1 stop
```

### 2. 查看状态

```powershell
.\scripts\graphdb.ps1 status

# 输出示例：
# GraphDB 服务状态
# ==================
# 状态: 运行中
# PID: 12345
# 启动时间: 2024/1/15 10:30:00
# 内存使用: 45.23 MB
# CPU时间: 00:00:05.2345678
#
# 配置信息
# --------
# 监听地址: http://127.0.0.1:9758
# 端口占用: 否
# 数据目录: D:\项目\database\graphDB\data
# 日志目录: D:\项目\database\graphDB\logs
# 配置文件: D:\项目\database\graphDB\config.toml
```

### 3. 查看日志

```powershell
# 查看最后 50 行（默认）
.\scripts\graphdb.ps1 logs

# 查看最后 100 行
.\scripts\graphdb.ps1 logs -Lines 100

# 实时跟踪日志（按 Ctrl+C 退出）
.\scripts\graphdb.ps1 logs -Lines 0
```

### 4. 停止服务

```powershell
.\scripts\graphdb.ps1 stop

# 输出示例：
# 正在停止 GraphDB 服务...
# 找到进程 PID: 12345
# GraphDB 服务已停止
```

---

## 命令详解

### start - 启动服务

启动 GraphDB 服务。

**参数：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `-ConfigPath` | string | "config.toml" | 配置文件路径 |
| `-DataDir` | string | "data" | 数据目录 |
| `-LogDir` | string | "logs" | 日志目录 |
| `-Foreground` | switch | false | 前台运行 |

**示例：**

```powershell
# 使用默认配置启动
.\scripts\graphdb.ps1 start

# 使用自定义配置
.\scripts\graphdb.ps1 start -ConfigPath myconfig.toml

# 前台运行（查看启动日志）
.\scripts\graphdb.ps1 start -Foreground

# 指定数据目录
.\scripts\graphdb.ps1 start -DataDir D:\GraphDB\Data
```

**注意事项：**
- 如果服务已在运行，会提示并退出
- 如果端口被占用，会报错并退出
- 首次启动会自动创建数据目录和日志目录

---

### stop - 停止服务

停止运行中的 GraphDB 服务。

**参数：** 无

**示例：**

```powershell
.\scripts\graphdb.ps1 stop
```

**说明：**
- 首先尝试优雅关闭（发送关闭信号）
- 如果 2 秒后仍未关闭，强制终止进程
- 自动清理 PID 文件

---

### restart - 重启服务

先停止服务，然后重新启动。

**参数：** 同 `start`

**示例：**

```powershell
# 简单重启
.\scripts\graphdb.ps1 restart

# 使用自定义配置重启
.\scripts\graphdb.ps1 restart -ConfigPath myconfig.toml
```

---

### status - 查看状态

显示 GraphDB 服务的运行状态和配置信息。

**参数：** 无

**示例：**

```powershell
.\scripts\graphdb.ps1 status
```

**显示信息：**
- 运行状态（运行中/未运行）
- 进程 ID (PID)
- 启动时间
- 内存使用情况
- CPU 使用时间
- 监听地址和端口
- 数据目录和日志目录位置

---

### logs - 查看日志

查看 GraphDB 的运行日志。

**参数：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `-Lines` | int | 50 | 显示行数，0 表示实时跟踪 |

**示例：**

```powershell
# 查看最后 50 行（默认）
.\scripts\graphdb.ps1 logs

# 查看最后 100 行
.\scripts\graphdb.ps1 logs -Lines 100

# 实时跟踪日志
.\scripts\graphdb.ps1 logs -Lines 0

# 只查看最后 10 行
.\scripts\graphdb.ps1 logs -Lines 10
```

**日志着色：**
- ERROR: 红色
- WARN: 黄色
- INFO: 青色
- 其他: 白色

---

### cli - 交互式 CLI

启动交互式命令行界面，可以直接执行查询。

**参数：** 无

**示例：**

```powershell
.\scripts\graphdb.ps1 cli

# 输出：
# GraphDB 交互式 CLI
# 输入 SQL 查询或命令 (exit 退出)
# ==================
# graphdb> MATCH (n) RETURN n LIMIT 5
# [查询结果...]
# graphdb> SHOW SPACES
# [查询结果...]
# graphdb> exit
```

**说明：**
- 服务必须正在运行才能使用 CLI
- 输入 `exit` 退出交互模式
- 每次输入一行查询语句

---

### info - 详细信息

显示 GraphDB 的详细统计信息。

**参数：** 无

**示例：**

```powershell
.\scripts\graphdb.ps1 info

# 输出示例：
# GraphDB 服务信息
# ==================
#
# 版本信息
# --------
# GraphDB 0.1.0
#
# 数据存储
# --------
# 数据目录: D:\项目\database\graphDB\data
# 数据大小: 12.34 MB
# 文件数量: 15
#
# 日志信息
# --------
# 日志目录: D:\项目\database\graphDB\logs
# 日志大小: 2.56 MB
# 日志文件: 3 个
#
# 使用帮助
# --------
# .\scripts\graphdb.ps1 start    # 启动服务
# .\scripts\graphdb.ps1 stop     # 停止服务
# .\scripts\graphdb.ps1 restart  # 重启服务
# .\scripts\graphdb.ps1 status   # 查看状态
# .\scripts\graphdb.ps1 logs     # 查看日志
# .\scripts\graphdb.ps1 info     # 详细信息
```

**显示信息：**
- 版本信息
- 数据存储统计（大小、文件数）
- 日志统计（大小、文件数）
- 常用命令帮助

---

## 常用工作流

### 工作流 1: 日常开发

```powershell
# 1. 启动服务
.\scripts\graphdb.ps1 start

# 2. 查看日志确认启动成功
.\scripts\graphdb.ps1 logs -Lines 20

# 3. 进行开发工作...

# 4. 查看服务状态
.\scripts\graphdb.ps1 status

# 5. 停止服务
.\scripts\graphdb.ps1 stop
```

### 工作流 2: 调试问题

```powershell
# 1. 前台启动（查看详细启动日志）
.\scripts\graphdb.ps1 start -Foreground

# 或：

# 1. 后台启动
.\scripts\graphdb.ps1 start

# 2. 实时跟踪日志
.\scripts\graphdb.ps1 logs -Lines 0
```

### 工作流 3: 数据查询

```powershell
# 1. 确保服务运行
.\scripts\graphdb.ps1 status

# 2. 进入交互 CLI
.\scripts\graphdb.ps1 cli

# 3. 执行查询
graphdb> MATCH (n) RETURN n LIMIT 10
graphdb> SHOW SPACES
graphdb> exit

# 或直接在命令行执行单次查询
.\target\release\graphdb.exe query --query "MATCH (n) RETURN n LIMIT 10"
```

### 工作流 4: 配置变更

```powershell
# 1. 停止当前服务
.\scripts\graphdb.ps1 stop

# 2. 修改配置文件 config.toml

# 3. 使用新配置启动
.\scripts\graphdb.ps1 start -ConfigPath config.toml

# 4. 验证新配置生效
.\scripts\graphdb.ps1 status
```

---

## 配置 PowerShell 别名

为了方便使用，可以添加 PowerShell 别名：

```powershell
# 临时别名（当前会话有效）
Set-Alias -Name gdb -Value .\scripts\graphdb.ps1

# 使用别名
gdb start
gdb status
gdb stop

# 永久别名（添加到 PowerShell Profile）
notepad $PROFILE

# 在文件中添加：
Set-Alias -Name gdb -Value "D:\项目\database\graphDB\scripts\graphdb.ps1"
```

---

## 故障排除

### 问题 1: "找不到 GraphDB 可执行文件"

**原因：** 脚本找不到 `graphdb.exe`

**解决：**
- 确保已编译项目：`cargo build --release`
- 或将 `graphdb.exe` 放到项目根目录

### 问题 2: "端口 9758 已被占用"

**原因：** 端口被其他程序占用

**解决：**
- 修改 `config.toml` 中的端口号
- 或查找并关闭占用端口的程序

### 问题 3: 服务启动后立即退出

**原因：** 配置错误或依赖缺失

**解决：**
```powershell
# 前台启动查看错误信息
.\scripts\graphdb.ps1 start -Foreground

# 或查看日志
.\scripts\graphdb.ps1 logs -Lines 50
```

### 问题 4: 停止服务时无响应

**原因：** 进程无响应

**解决：**
```powershell
# 手动强制终止
Get-Process graphdb | Stop-Process -Force

# 然后清理 PID 文件
Remove-Item .\data\graphdb.pid -Force
```

### 问题 5: PID 文件存在但服务未运行

**原因：** 异常退出导致 PID 文件未清理

**解决：**
```powershell
# 脚本会自动检测并清理
.\scripts\graphdb.ps1 status

# 然后正常启动
.\scripts\graphdb.ps1 start
```

---

## 文件说明

| 文件/目录 | 说明 |
|-----------|------|
| `scripts/graphdb.ps1` | 服务管理脚本 |
| `data/graphdb.pid` | PID 文件（自动创建） |
| `data/graphdb/` | 数据存储目录 |
| `logs/graphdb.log` | 日志文件 |
| `config.toml` | 默认配置文件 |

---

## 注意事项

1. **管理员权限**：通常不需要管理员权限，但如果端口 < 1024 则需要
2. **防火墙**：首次运行可能需要允许防火墙访问
3. **数据备份**：重要数据请定期备份 `data/` 目录
4. **日志清理**：日志会自动轮转，但长期运行建议定期清理旧日志

---

## 更新日志

### v1.0 (2024-01-15)
- 初始版本
- 支持 start/stop/restart/status/logs/cli/info 命令
- 支持后台/前台启动
- 支持彩色日志输出
